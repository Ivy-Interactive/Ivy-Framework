# Ivy Database Integration

<Ingress>
Connect your Ivy application to various databases with automatic Entity Framework configuration for SQL Server, PostgreSQL, MySQL, SQLite, and more.
</Ingress>

The `ivy db` commands allow you to add and manage database connections in your Ivy project. Ivy supports a wide range of database providers and automatically generates the necessary Entity Framework configurations.

## Supported Database Providers

Ivy supports the following database providers:

### Relational Databases

- **SQL Server** - Microsoft's enterprise database
- **PostgreSQL** - Advanced open-source database
- **MySQL** - Popular open-source database
- **MariaDB** - MySQL fork with enhanced features
- **SQLite** - Lightweight file-based database
- **Oracle** - Enterprise database system

### Cloud Databases

- **Supabase** - Open-source Firebase alternative with PostgreSQL
- **Google Spanner** - Globally distributed database
- **Snowflake** - Cloud data platform

### Specialized Databases

- **ClickHouse** - Column-oriented database for analytics
- **Airtable** - Spreadsheet-database hybrid

## Basic Usage

### Adding a Database Connection

```terminal
>ivy db add
```

This command will:

- Prompt you to select a database provider
- Ask for a connection name
- Generate the necessary Entity Framework configuration
- Set up connection strings and secrets management

### Generating Database Context

```terminal
>ivy db generate
```

Generate Entity Framework DbContext for your database connections.

## Command Options

`--provider <PROVIDER>` - Specify the database provider directly:

```terminal
>ivy db add --provider Postgres
```

Available providers: `SqlServer`, `Postgres`, `MySql`, `MariaDb`, `Sqlite`, `Supabase`, `Airtable`, `Oracle`, `Spanner`, `ClickHouse`, `Snowflake`

`--name <CONNECTION_NAME>` - Specify the connection name in PascalCase:

```terminal
>ivy db add --name MyDatabase
```

`--connection-string <CONNECTION_STRING>` - Provide the connection string directly:

```terminal
>ivy db add --provider Postgres --connection-string YourConnectionString
```

`--schema <SCHEMA>` - Specify the database schema (for providers that support it):

```terminal
>ivy db add --provider Postgres --schema public
```

`--verbose` - Enable verbose output for detailed logging:

```terminal
>ivy db add --verbose
```

### Interactive Mode

When you run `ivy db add` without specifying options, Ivy will guide you through an interactive setup:

1. **Select Database Provider**: Choose from the available providers
2. **Connection Name**: Enter a name for your connection (PascalCase recommended)
3. **Connection String**: Provide the connection string or let Ivy help you build it

### Connection Management

### Connection Structure

Each database connection creates a folder structure:

```text
Connections/
└── [ConnectionName]/
    ├── [ConnectionName]Context.cs             # Entity Framework DbContext
    ├── [ConnectionName]ContextFactory.cs      # DbContext factory
    ├── [ConnectionName]Connection.cs          # Connection configuration
    └── [EntityName].cs...                     # One or more generated entity classes
```

### Connection Configuration

Ivy automatically configures:

- **Entity Framework Core** with the appropriate provider
- **Connection strings** stored securely using .NET User Secrets
- **DbContext** with proper configuration

### Database-Specific Configuration

**SQL Server**

```terminal
>ivy db add --provider SqlServer --name MySqlServer
```

**Connection String Format:**
```text
Server=localhost;Database=mydb;Trusted_Connection=true;
```

**PostgreSQL**

```terminal
>ivy db add --provider Postgres --name MyPostgres
```

**Connection String Format:**

```text
Host=localhost;Database=mydb;Username=user;Password=pass
```

**MySQL/MariaDB**

```terminal
>ivy db add --provider MySql --name MyMySql
```

**Connection String Format:**

```text
Server=localhost;Database=mydb;Uid=user;Pwd=pass
```

**SQLite**

```terminal
>ivy db add --provider Sqlite --name MySqlite
```

**Connection String Format:**

```text
Data Source=data.db
```

**Supabase**

```terminal
>ivy db add --provider Supabase --name MySupabase
```

**Connection String Format:**

```text
Host=your-project.supabase.co;Database=postgres;Username=postgres;Password=your-password
```

### Security and Secrets Management

Ivy automatically configures .NET User Secrets for secure connection string storage:

```terminal
>dotnet user-secrets list
```

### Environment Variables

You can also use environment variables for connection strings (with the exception of SQLite):

```text
export ConnectionStrings__MY_DATABASE_CONNECTION_STRING="Host=localhost;Database=mydb;Username=user;Password=pass"
```

### Entity Framework Integration

**Connection** - Ivy generates a class for each connection to facilitate communication with the database provider:

```csharp
public class MyDatabaseConnection : IConnection
{
    public string GetContext(string connectionPath)
    {
        var connectionFile = nameof(MyDatabaseConnection) + ".cs";
        var contextFactoryFile = nameof(MyDatabaseContextFactory) + ".cs";
        var files = Directory.GetFiles(connectionPath, "*.*", SearchOption.TopDirectoryOnly)
            .Where(f => !f.EndsWith(connectionFile) && !f.EndsWith(contextFactoryFile))
            .Select(File.ReadAllText)
            .ToArray();
        return string.Join(Environment.NewLine, files);
    }

    public string GetName() => nameof(MyDatabase);

    public string GetNamespace() => typeof(MyDatabaseConnection).Namespace;

    public ConnectionEntity[] GetEntities()
    {
        return typeof(MyDatabaseContext)
            .GetProperties()
            .Where(e => e.PropertyType.IsGenericType && e.PropertyType.GetGenericTypeDefinition() == typeof(DbSet<>))
            .Select(e => new ConnectionEntity(e.PropertyType.GenericTypeArguments[0].Name, e.Name))
            .ToArray();
    }

    public void RegisterServices(IServiceCollection services)
    {
        services.AddSingleton<MyDatabaseContextFactory>();
    }
}
```

**DbContext** - A DbContext class is also generated for each connection:

```csharp
public partial class MyDatabaseContext : DbContext
{
    public MyDatabaseContext(DbContextOptions<MyDatabaseContext> options)
        : base(options)
    {
    }

    public virtual DbSet<Employee> Employees { get; set; }

    public virtual DbSet<Order> Orders { get; set; }

    protected override void OnModelCreating(ModelBuilder modelBuilder)
    {
        modelBuilder.Entity<Employee>(entity =>
        {
            entity.Property(e => e.Id).ValueGeneratedNever();
        });

        modelBuilder.Entity<Order>(entity =>
        {
            entity.Property(e => e.Id).ValueGeneratedNever();
        });

        OnModelCreatingPartial(modelBuilder);
    }

    partial void OnModelCreatingPartial(ModelBuilder modelBuilder);
}
```

**DbContext Factory** - Finally, a context factory class is generated for dependency injection:

```csharp
public class MyDatabaseContextFactory(ServerArgs args) : IDbContextFactory<MyDatabaseContext>
{
    public MyDatabaseContext CreateDbContext()
    {
        var configuration = new ConfigurationBuilder()
           .AddEnvironmentVariables()
           .AddUserSecrets(Assembly.GetExecutingAssembly())
           .Build();

        var optionsBuilder = new DbContextOptionsBuilder<MyDatabaseContext>();

        var connectionString = configuration.GetConnectionString("MY_DATABASE_CONNECTION_STRING");

        if (string.IsNullOrWhiteSpace(connectionString))
        {
            throw new InvalidOperationException("Database connection string 'MY_DATABASE_CONNECTION_STRING' is not set.");
        }

        // Ivy will use the appropriate method for your chosen DB provider here
        optionsBuilder.UseDbProvider(connectionString);

        if (args.Verbose)
        {
            optionsBuilder
                .EnableSensitiveDataLogging()
                .LogTo(Console.WriteLine, LogLevel.Information);
        }

        return new MyDatabaseContext(optionsBuilder.Options);
    }
}
```

### Multiple Database Connections

You can add multiple database connections to a single project:

```terminal
>ivy db add --provider Postgres --name PrimaryDb
>ivy db add --provider Sqlite --name LogDb
>ivy db add --provider ClickHouse --name AnalyticsDb
```

### Troubleshooting

**Connection String Issues** - Ensure the connection string format is correct for your provider, verify database server is running and accessible, and check firewall settings and network connectivity.

**Entity Framework Issues** - Ensure required NuGet packages are installed, verify .NET EF tools are installed: `dotnet tool install -g dotnet-ef`, and check for conflicting Entity Framework versions.

**Authentication Issues** - Ensure you're logged in: `ivy login` and verify your Ivy account has the necessary permissions.

## Examples

**Basic PostgreSQL Setup**

```terminal
>ivy db add --provider Postgres --name MyProjectDb
```

**SQL Server with Custom Schema**

```terminal
>ivy db add --provider SqlServer --name InventoryDb --schema dbo
```

**Supabase Integration**

```terminal
>ivy db add --provider Supabase --name UserDb
```

**Multiple Databases**

```terminal
>ivy db add --provider Postgres --name PrimaryDb
>ivy db add --provider Sqlite --name LogDb
>ivy db add --provider ClickHouse --name AnalyticsDb
```

## Related Commands

- `ivy init` - Initialize a new Ivy project
- `ivy auth add` - Add authentication providers
- `ivy app create` - Create apps
- `ivy deploy` - Deploy your project